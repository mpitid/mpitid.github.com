<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
        <title>SSH Hops</title>
        <link rel="stylesheet" type="text/css" href="../css/syntax.css"></link>
        <link rel="stylesheet" type="text/css" href="../css/base.css"></link></head>

    <body>
        <div id="navbar">
            <ul>
<li><a href="../index.html">home</a></li>
<li><a href="../projects.html">projects</a></li>
<li><a href="../posts.html">ramblings</a></li>
<li><a href="../about.html">about</a></li>
</ul></div>

        <div id="content">
        <h1>SSH Hops</h1>

<p>by <em>Mike</em> on <strong>2012-01-30</strong></p>

<p>Last night I got really fed up with the <code>SSH</code> setup in Informatics at UoE, so I finally set out to automate it as much as I could and get rid of some ad-hoc scripts and aliases I had been using so far. In the process, I discovered some really cool <code>SSH</code> features, which I describe later on.</p>
<p>First of all, I had to set up Kerberos because key-based authentication is disabled. This was a simple matter of installing the <code>krb5-user</code> debian package, adding INF.ED.AC.UK as the domain and running:<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup></p>
<pre><code> kinit sxxxxxxx@inf.ed.ac.uk
</code></pre>
<p>I could then login with Kerberos credentials by passing the <code>-K</code> flag to <code>SSH</code>.</p>
<p>What’s equally useful however is bypassing the <code>SSH</code> gateway. The best way to do this is by using the <code>ProxyCommand</code> option of <code>SSH</code>. I found a <a href="http://www.jedi.be/blog/2008/11/07/chaining-ssh-tunnels-easy-ssh-hopping/">blog post</a> explaining its usage, while a more elaborate configuration allowing for arbitrary hops is described in <a href="http://www.reddit.com/r/linux/comments/fw4s0/">reddit</a>. What follows is the corresponding snippet from my <code>~/.ssh/config</code> file:</p>
<pre><code>Compression yes

# SSH Gateway.
Host inf
User sxxxxxxx
GSSAPIDelegateCredentials yes
HostName student.ssh.inf.ed.ac.uk

# Compute server.
Host compute
User sxxxxxxx
Cipher blowfish
GSSAPIDelegateCredentials yes
HostName student.compute.inf.ed.ac.uk
ProxyCommand ssh inf nc -w 240 student.compute 22

# NESS HPC server.
Host ness
User sxxxxxxx
Cipher blowfish
HostName ness.epcc.ed.ac.uk
ProxyCommand ssh inf nc -w 240 ness.epcc.ed.ac.uk 22

# Gerrit/Git hosting service.
Host gerrit
Port 29418
User sxxxxxxx
Cipher blowfish
HostName gerrit.not-a-service.inf.ed.ac.uk

# SOCKS5 proxy for Firefox:
# Invoke as `ssh -Nn tunnel` and add the following settings in user.js:
# user_pref(&quot;network.proxy.socks&quot;, &quot;localhost&quot;);
# user_pref(&quot;network.proxy.socks_port&quot;, 8080);
# user_pref(&quot;network.proxy.socks_remote_dns&quot;, true);
# user_pref(&quot;network.proxy.type&quot;, 1);
Host tunnel
User sxxxxxxx
GSSAPIDelegateCredentials yes
HostName student.ssh.inf.ed.ac.uk
DynamicForward localhost:8080
Cipher blowfish
LogLevel QUIET
RequestTTY no
</code></pre>
<p>This works seamlessly with <code>sshfs</code>, and I can now mount <em>compute</em>’s ramdisk —which I use for scratch space— to circumvent my quota restrictions, e.g.</p>
<pre><code>sshfs compute:/dev/shm/mike ~/mnt
</code></pre>
<p>Initially <code>sshfs</code> and <code>scp</code> would not work correctly. After some digging around I discovered the culprit in my remote <code>.bashrc</code> file. Because I did not have permissions to change my default shell to my local installation of <code>zsh</code>, I had placed an <code>exec zsh</code> command on the end of the <code>.bashrc</code> file. This was problematic for non-interactive shells, like those invoked by <code>scp</code> and <code>sshfs</code>. The solution was to move the offending snippet to <code>~/.bash_login</code>.</p>
<p>Besides the proxy setup, the above configuration adds handy shortcuts for the hosts. The <code>GSSAPIDelegateCredentials</code> option is the equivalent of the <code>-K</code> flag. For <em>ness</em> and <em>gerrit</em> I just use key-based authentication. The <code>-w 240</code> is there to clean up the netcat process after 2 minutes of inactivity.</p>
<p>The final entry is for tunneling my Firefox traffic through the SSH gateway. This is useful because the IP pool of the university’s VPN does not provide access to all services. It also allows me to cleanly separate my university traffic. For a similar setup, just add a SOCKS5 proxy from the Network Preferences, and set <code>socks_remote_dns</code> to <code>true</code> in <code>about:config</code>. Alternatively, paste the commented lines in a file named <code>user.js</code> inside your Firefox profile directory.</p>
<!-- vim: set ft=markdown tw=72: -->


<div class="footnotes">
<hr></hr>
<ol>
<li id="fn1"><p><a href="http://www.inf.ed.ac.uk/systems/support/FAQ/#KB5">Informatics Support FAQ</a> <a href="#fnref1" class="footnoteBackLink">↩</a></p></li>
</ol>
</div>


        <div id="powered">
        <fieldset><legend>Powered by</legend>
            <ul>
                <li><a href="http://www.gnu.org">Free Software</a></li>
                <li><a href="http://www.vim.org">Vim</a></li>
                <li><a href="http://jaspervdj.be/hakyll/">Hakyll</a></li>
                <li><a href="http://johnmacfarlane.net/pandoc/">Pandoc</a></li>
                <li><a href="http://sass-lang.com">Sass</a></li>
            </ul></div></div>

    </body></html>
